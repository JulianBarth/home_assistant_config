# SPDX-License-Identifier: BSD-3-Clause
#
# Copyright (c) 2024, Julian Bartholomeyczik
# All rights reserved.

# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

# Lovelace UI configuration
lovelace:
  resource_mode: yaml
  resources:
    - url: /hacsfiles/ha-sankey-chart/ha-sankey-chart.js
      type: module
    - url: /hacsfiles/power-flow-card-plus/power-flow-card-plus.js
      type: module
  dashboards:
    lovelace:
      mode: yaml
      filename: ui-lovelace.yaml
      title: Overview
      icon: mdi:view-dashboard
      show_in_sidebar: true
    lovelace-battery:
      mode: yaml
      title: Battery Management
      icon: mdi:battery-charging
      show_in_sidebar: true
      filename: ui-lovelace.yaml

# Helper
input_boolean:
  battery_charging_active:
    name: Battery Charging Active
    icon: mdi:battery-charging
  battery_no_discharging_active:
    name: Battery No Discharging
    icon: mdi:battery-lock
  battery_automation_on:
    name: Battery Charge Automation is On
    icon: mdi:state-machine
    initial: true
  manual_charging_on:
    name: Manual Charging On
    icon: mdi:battery-charging
  manual_battery_charge:
    name: Manual Battery Charge
    initial: false

input_number:
  battery_target_soc:
    name: Battery Target SoC
    initial: 100
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
  manual_charge_target_soc:
    name: Manual Charge Target SoC
    initial: 80
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"

  sun_threshold_low:
    name: Expected Sun Low Threshold
    initial: 15000
    min: 0
    max: 50000
    step: 1000
    unit_of_measurement: "Wh"

  sun_threshold_very_low:
    name: Expected Sun Very Low Threshold
    initial: 8000
    min: 0
    max: 50000
    step: 1000
    unit_of_measurement: "Wh"

  soc_target_very_low_sun:
    name: Target SoC for Very Low Sun
    initial: 90
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"

  soc_target_low_sun:
    name: Target SoC for Low Sun
    initial: 50
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"

  soc_target_default:
    name: Default Target SoC
    initial: 15
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"

  soc_hist:
    name: SoC Hysteresis
    step: 0.5
    min: 0
    max: 25
    initial: 5
    icon: mdi:thermometer

  # Grid capacity setting
  grid_connection_capacity:
    name: Grid Connection Capacity
    initial: 40000
    min: 5000
    max: 50000
    step: 1000
    unit_of_measurement: "W"
    icon: mdi:transmission-tower

  # Battery parameters
  battery_charge_rate_max:
    name: Maximum Battery Charge Rate
    initial: 10000
    min: 1000
    max: 10000
    step: 500
    unit_of_measurement: "W"
    icon: mdi:lightning-bolt

  # Economic parameters
  battery_wear_cost_per_kwh:
    name: Battery Wear Cost
    initial: 2
    min: 0
    max: 10
    step: 0.5
    unit_of_measurement: "Cent/kWh"
    icon: mdi:cash-minus

  # Hysteresis parameters
  battery_hold_threshold:
    name: Battery Hold Threshold
    initial: 3
    min: 1
    max: 10
    step: 0.5
    unit_of_measurement: "%"
    icon: mdi:arrow-split-horizontal

  battery_discharge_buffer:
    name: Battery Discharge Buffer
    initial: 5
    min: 0
    max: 20
    step: 1
    unit_of_measurement: "%"
    icon: mdi:buffer

  car_charging_hysteresis_minutes:
    name: Car Charging State Hysteresis
    initial: 3
    min: 0
    max: 15
    step: 1
    unit_of_measurement: "min"
    icon: mdi:timer-outline

  # Battery capacity for solar-to-SoC calculations
  battery_capacity_wh:
    name: Battery Capacity
    initial: 10000
    min: 1000
    max: 50000
    step: 100
    unit_of_measurement: "Wh"
    icon: mdi:battery-high

  # Smart charging algorithm parameters
  daily_consumption_wh:
    name: Daily Consumption (All Day)
    initial: 14000
    min: 1000
    max: 50000
    step: 100
    unit_of_measurement: "Wh"
    icon: mdi:home-lightning-bolt

  night_consumption_rate_wh:
    name: Night Consumption Rate (22:00-wake)
    initial: 280
    min: 50
    max: 600
    step: 10
    unit_of_measurement: "Wh/h"
    icon: mdi:sleep

  day_consumption_rate_wh:
    name: Day Consumption Rate (wake-22:00)
    initial: 850
    min: 200
    max: 2000
    step: 10
    unit_of_measurement: "Wh/h"
    icon: mdi:run

  weekday_wake_hour:
    name: Weekday Wake Hour
    initial: 5.5
    min: 0
    max: 12
    step: 0.5
    unit_of_measurement: "h"
    icon: mdi:alarm

  weekend_wake_hour:
    name: Weekend Wake Hour
    initial: 7.5
    min: 0
    max: 12
    step: 0.5
    unit_of_measurement: "h"
    icon: mdi:alarm-snooze

  sleep_hour:
    name: Sleep Hour (Highâ†’Low Consumption)
    initial: 22
    min: 18
    max: 24
    step: 0.5
    unit_of_measurement: "h"
    icon: mdi:power-sleep

  # Price ceiling for charging decisions
  max_charge_price_cents:
    name: Maximum Charging Price
    initial: 25
    min: 0
    max: 50
    step: 1
    unit_of_measurement: "Cent/kWh"
    icon: mdi:currency-eur

  # Low solar threshold for winter mode detection
  low_solar_threshold_wh:
    name: Low Solar Forecast Threshold
    initial: 3000
    min: 500
    max: 10000
    step: 500
    unit_of_measurement: "Wh"
    icon: mdi:weather-sunny-off

sensor:

  - platform: rest
    name: "Tibber Energy Prices"
    resource: https://api.tibber.com/v1-beta/gql
    method: POST
    payload: '{ "query": "{ viewer { homes { currentSubscription { priceInfo(resolution: QUARTER_HOURLY) { current { total startsAt } today { total startsAt } tomorrow { total startsAt } } } } } }" }'
    json_attributes_path: "$.data.viewer.homes[0].currentSubscription.priceInfo"
    json_attributes:
      - today
      - tomorrow
    value_template: "{{ value_json.data.viewer.homes[0].currentSubscription.priceInfo.current.total | float }}"
    scan_interval: 30
    headers:
      Authorization: !secret tibber_api_key
      Content-Type: application/json
      User-Agent: REST
    unit_of_measurement: EUR/kWh
  # Riemann Sum Integral Sensors for Energy Dashboard
  - platform: integration
    source: sensor.grid_import_power
    name: grid_import_energy
    unit_prefix: k
    round: 2
    method: left
  - platform: integration
    source: sensor.grid_export_power
    name: grid_export_energy
    unit_prefix: k
    round: 2
    method: left
  - platform: integration
    source: sensor.total_solar_power
    name: solar_energy
    unit_prefix: k
    round: 2
    method: left
  - platform: integration
    source: sensor.battery_charge_power
    name: battery_charge_energy
    unit_prefix: k
    round: 2
    method: left
  - platform: integration
    source: sensor.battery_discharge_power
    name: battery_discharge_energy
    unit_prefix: k
    round: 2
    method: left

# Structured algorithm logging
notify:
  - name: battery_log
    platform: file
    filename: /config/battery_algorithm.log
    timestamp: false

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml
modbus: !include modbus.yaml
template: !include templates.yaml
