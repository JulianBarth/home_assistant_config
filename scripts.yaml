# SPDX-License-Identifier: BSD-3-Clause
#
# Copyright (c) 2024, Julian Bartholomeyczik
# All rights reserved.

# =============================================================================
# BATTERY CHARGE RATE CONTROL SCRIPTS
# These scripts control the Fronius inverter via Modbus to set charge/discharge rates
# Modbus registers: 40365 (OutWRte - discharge), 40366 (InWRte - charge)
# Values are in 0.01% increments (10000 = 100%)
# =============================================================================

set_regular_charge:
  alias: "Set Regular Charge"
  description: "Restore normal charge/discharge behavior (100% both directions)"
  sequence:
    # OutWRte - Set discharge rate to 100%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 10000
    # InWRte - Set charge rate to 100%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

set_limited_discharge:
  alias: "Set Limited Discharge"
  description: "Limit battery discharge to 10% (used during car charging)"
  sequence:
    # OutWRte - Limit discharge to 10% of max power
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 1000
    # InWRte - Allow full charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

half_regular_charge:
  alias: "Half Regular Charge"
  description: "Set both charge and discharge to 50% of maximum"
  sequence:
    # OutWRte - Set discharge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 5000
    # InWRte - Set charge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 5000

discharge_at_half_rate:
  alias: "Discharge at Half Rate"
  description: "Discharge at 50% while preventing charging"
  sequence:
    # OutWRte - Set discharge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 5000
    # InWRte - Prevent charging (negative value: 65536 - 5000 = 60536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 60536

forced_half_recharge:
  alias: "Forced Half Recharge"
  description: "Force charging at minimum 50% power"
  sequence:
    # OutWRte - Prevent discharge (negative value: 65536 - 5000 = 60536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 60536
    # InWRte - Allow full charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

forced_full_recharge:
  alias: "Forced Full Recharge"
  description: "Force charging at maximum power while preventing discharge"
  sequence:
    # OutWRte - Prevent discharge (negative value: 65536 - 8000 = 57536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 57536
    # InWRte - Allow maximum charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

# =============================================================================
# HOLD SOC BATTERY CONTROL SCRIPTS
# These scripts implement efficient battery SOC holding by setting minimal charge/discharge rates
# This prevents the inefficient cycle of charging and discharging to maintain SOC
# =============================================================================

hold_battery_soc:
  alias: "Hold Battery SOC"
  description: "Hold battery at current SOC by minimizing charge/discharge rates (more efficient than alternating)"
  sequence:
    # OutWRte - Set discharge to 1% (minimal discharge)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 100
    # InWRte - Set charge to 1% (minimal charge)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 100
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod

# =============================================================================
# TEST FUNCTIONS FOR HOLD SOC FUNCTIONALITY
# These scripts allow users to test the hold SOC commands before deploying to production
# =============================================================================

test_hold_soc_enable:
  alias: "TEST: Enable Hold SOC"
  description: "Test script to enable hold SOC mode - Battery should enter HOLDING state (ChaSt=6)"
  sequence:
    # First, enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    - delay:
        seconds: 2
    # Set minimal charge and discharge rates to hold SOC
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 100  # 1% discharge
    - delay:
        seconds: 1
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 100  # 1% charge
    - delay:
        seconds: 2
    # Notify user to check battery state
    - service: persistent_notification.create
      data:
        title: "Hold SOC Test Enabled"
        message: >
          Hold SOC mode has been activated.
          
          **Expected behavior:**
          - Battery should stop charging/discharging
          - Charging State (ChaSt) should show "HOLDING" (value 6)
          - Battery SoC should remain relatively stable
          
          **Check the following sensors:**
          - sensor.charging_state (should be "HOLDING")
          - sensor.batterie_soc (should be stable)
          - sensor.battery_power (should be near 0W)
          
          **Next steps:**
          1. Monitor for 5-10 minutes
          2. If working correctly, run "TEST: Disable Hold SOC"
          3. Report results to verify functionality

test_hold_soc_disable:
  alias: "TEST: Disable Hold SOC"
  description: "Test script to disable hold SOC mode and return to normal operation"
  sequence:
    # Restore regular charge/discharge rates (100%)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 10000
    - delay:
        seconds: 1
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000
    - delay:
        seconds: 1
    # Disable storage control mode
    - action: switch.turn_off
      target:
        entity_id: switch.StorCtl_Mod
    # Notify user
    - service: persistent_notification.create
      data:
        title: "Hold SOC Test Disabled"
        message: >
          Hold SOC mode has been deactivated. Battery has returned to normal operation.
          
          **Expected behavior:**
          - Battery should resume normal charge/discharge cycles
          - StorCtl_Mod should be OFF
          - System should respond to solar production and consumption
          
          If the test was successful, you can now integrate hold_battery_soc into your automations.

test_hold_soc_status:
  alias: "TEST: Check Hold SOC Status"
  description: "Check current battery control status and display key metrics"
  sequence:
    - service: persistent_notification.create
      data:
        title: "Battery Hold SOC Status"
        message: >
          **Current Battery Status:**
          
          - **Battery SoC:** {{ states('sensor.batterie_soc') }}%
          - **Charging State:** {{ states('sensor.charging_state') }}
          - **ChaSt Value:** {{ states('sensor.ChaSt') }}
          - **Battery Power:** {{ states('sensor.battery_power') }}W
          - **StorCtl_Mod:** {{ states('switch.StorCtl_Mod') }}
          
          **Control Registers:**
          - **Discharge Rate (OutWRte):** {{ states('sensor.percent_max_discharge_rte') }}%
          - **Charge Rate (InWRte):** {{ states('sensor.percent_max_charge_rte') }}%
          
          **Expected for Hold Mode:**
          - Charging State: HOLDING
          - ChaSt Value: 6
          - Battery Power: ~0W (Â±100W)
          - StorCtl_Mod: on
          - Discharge/Charge Rates: 1% (100 in register)

# =============================================================================
# HIGH-LEVEL BATTERY CONTROL SCRIPTS
# These scripts orchestrate battery charging and discharging automation
# =============================================================================

start_battery_charging:
  alias: "Start Battery Charging with Target SoC"
  description: "Activate battery charging mode with forced full recharge"
  sequence:
    # Configure inverter for forced full recharge
    - service: script.turn_on
      target:
        entity_id: script.forced_full_recharge
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # Set status flag
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_charging_active

stop_battery_charging:
  alias: "Stop Battery Charging"
  description: "Deactivate battery charging and restore normal behavior"
  sequence:
    # Restore regular charge/discharge behavior
    - service: script.turn_on
      target:
        entity_id: script.set_regular_charge
    # Disable storage control mode
    - action: switch.turn_off
      target:
        entity_id: switch.StorCtl_Mod
    # Clear status flag
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.battery_charging_active

start_limit_discharging:
  alias: "Start Limit Discharging"
  description: "Limit battery discharge (e.g., during car charging)"
  sequence:
    # Configure inverter for limited discharge
    - service: script.turn_on
      target:
        entity_id: script.set_limited_discharge
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # Set status flag
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_no_discharging_active

stop_limit_discharging:
  alias: "Stop Limit Discharging"
  description: "Remove discharge limitation and restore normal behavior"
  sequence:
    # Restore regular charge/discharge behavior
    - service: script.turn_on
      target:
        entity_id: script.set_regular_charge
    # Disable storage control mode
    - action: switch.turn_off
      target:
        entity_id: switch.StorCtl_Mod
    # Clear status flag
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.battery_no_discharging_active

charge_battery_limit_discharge:
  alias: "Charge Battery with Limited Discharge"
  description: "Charge battery while limiting discharge for car charging"
  sequence:
    # Set charge rate to 100%, discharge to 10%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 1000  # 10% discharge limit
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000  # 100% charge rate
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # Set both flags
    - service: input_boolean.turn_on
      target:
        entity_id:
          - input_boolean.battery_charging_active
          - input_boolean.battery_no_discharging_active

set_dynamic_discharge_limit:
  alias: "Set Dynamic Discharge Limit"
  description: "Adjust discharge limit based on grid prices and battery SoC"
  sequence:
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: >
          {% set raw_value = states('sensor.discharge_limit_percentage') %}
          {% if raw_value in ['unavailable', 'unknown', 'none', 'None'] %}
            1000
          {% else %}
            {{ (raw_value | float(default=10) * 100) | int }}
          {% endif %}
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000
    - service: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
