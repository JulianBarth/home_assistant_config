# SPDX-License-Identifier: BSD-3-Clause
#
# Copyright (c) 2024, Julian Bartholomeyczik
# All rights reserved.

# =============================================================================
# BATTERY CHARGE RATE CONTROL SCRIPTS
# These scripts control the Fronius inverter via Modbus to set charge/discharge rates
# Modbus registers: 40365 (OutWRte - discharge), 40366 (InWRte - charge)
# Values are in 0.01% increments (10000 = 100%)
# =============================================================================

set_regular_charge:
  alias: "Set Regular Charge"
  description: "Restore normal charge/discharge behavior (100% both directions)"
  sequence:
    # OutWRte - Set discharge rate to 100%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 10000
    # InWRte - Set charge rate to 100%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

set_limited_discharge:
  alias: "Set Limited Discharge"
  description: "Limit battery discharge to 10% (used during car charging)"
  sequence:
    # OutWRte - Limit discharge to 10% of max power
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 1000
    # InWRte - Allow full charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

half_regular_charge:
  alias: "Half Regular Charge"
  description: "Set both charge and discharge to 50% of maximum"
  sequence:
    # OutWRte - Set discharge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 5000
    # InWRte - Set charge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 5000

discharge_at_half_rate:
  alias: "Discharge at Half Rate"
  description: "Discharge at 50% while preventing charging"
  sequence:
    # OutWRte - Set discharge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 5000
    # InWRte - Prevent charging (negative value: 65536 - 5000 = 60536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 60536

forced_half_recharge:
  alias: "Forced Half Recharge"
  description: "Force charging at minimum 50% power"
  sequence:
    # OutWRte - Prevent discharge (negative value: 65536 - 5000 = 60536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 60536
    # InWRte - Allow full charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

forced_full_recharge:
  alias: "Forced Full Recharge"
  description: "Force charging at maximum power while preventing discharge"
  sequence:
    # OutWRte - Prevent discharge (negative value: 65536 - 8000 = 57536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 57536
    # InWRte - Allow maximum charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

# =============================================================================
# HIGH-LEVEL BATTERY CONTROL SCRIPTS
# These scripts orchestrate battery charging and discharging automation
# =============================================================================

start_battery_charging:
  alias: "Start Battery Charging with Target SoC"
  description: "Activate battery charging mode with forced full recharge"
  sequence:
    # Configure inverter for forced full recharge
    - service: script.turn_on
      target:
        entity_id: script.forced_full_recharge
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # Set status flag
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_charging_active

stop_battery_charging:
  alias: "Stop Battery Charging"
  description: "Deactivate battery charging and restore normal behavior"
  sequence:
    # Restore regular charge/discharge behavior
    - service: script.turn_on
      target:
        entity_id: script.set_regular_charge
    # Disable storage control mode
    - action: switch.turn_off
      target:
        entity_id: switch.StorCtl_Mod
    # Clear status flag
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.battery_charging_active

start_limit_discharging:
  alias: "Start Limit Discharging"
  description: "Limit battery discharge (e.g., during car charging)"
  sequence:
    # Configure inverter for limited discharge
    - service: script.turn_on
      target:
        entity_id: script.set_limited_discharge
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # Set status flag
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_no_discharging_active

stop_limit_discharging:
  alias: "Stop Limit Discharging"
  description: "Remove discharge limitation and restore normal behavior"
  sequence:
    # Restore regular charge/discharge behavior
    - service: script.turn_on
      target:
        entity_id: script.set_regular_charge
    # Disable storage control mode
    - action: switch.turn_off
      target:
        entity_id: switch.StorCtl_Mod
    # Clear status flag
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.battery_no_discharging_active

charge_battery_limit_discharge:
  alias: "Charge Battery with Limited Discharge"
  description: "Charge battery while limiting discharge for car charging"
  sequence:
    # Set charge rate to 100%, discharge to 10%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 1000  # 10% discharge limit
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000  # 100% charge rate
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # Set both flags
    - service: input_boolean.turn_on
      target:
        entity_id:
          - input_boolean.battery_charging_active
          - input_boolean.battery_no_discharging_active

set_dynamic_discharge_limit:
  alias: "Set Dynamic Discharge Limit"
  description: "Adjust discharge limit based on grid prices and battery SoC"
  sequence:
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: >
          {% set limit_percent = states('sensor.discharge_limit_percentage') | float(default=10) %}
          {{ (limit_percent * 100) | int }}
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000
    - service: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod

# =============================================================================
# BATTERY HOLD SOC CONTROL SCRIPTS
# These scripts implement efficient "hold SOC" mode to keep battery at target level
# Instead of cycling charge/discharge, battery remains steady at desired SOC
# Modbus registers: 40358 (StorCtl_Mod), 40365 (OutWRte), 40366 (InWRte)
# =============================================================================

hold_battery_soc:
  alias: "Hold Battery SOC"
  description: "Keep battery steady at current SOC (most efficient - no cycling)"
  sequence:
    # Enable storage control mode first
    - service: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # OutWRte - Disable discharge (set to 0%)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 0
    # InWRte - Disable charge (set to 0%)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 0

hold_battery_soc_minimal:
  alias: "Hold Battery SOC (Minimal Rate)"
  description: "Keep battery steady with minimal 1% charge/discharge allowance"
  sequence:
    # Enable storage control mode first
    - service: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # OutWRte - Minimal discharge (1%)
    # Note: Register value 100 = 1% (register uses 0.01% increments, so 100 units = 1%)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 100
    # InWRte - Minimal charge (1%)
    # Note: Register value 100 = 1% (register uses 0.01% increments, so 100 units = 1%)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 100

# =============================================================================
# TEST FUNCTIONS FOR HOLD SOC VALIDATION
# Use these scripts to test if hold SOC commands work properly before deployment
# =============================================================================

test_hold_soc_zero_rates:
  alias: "TEST: Hold SOC with Zero Rates"
  description: "Test script - Hold battery by setting charge/discharge to 0%"
  sequence:
    - service: notify.persistent_notification
      data:
        title: "Battery Hold SOC Test Started"
        message: >
          Testing hold SOC with zero rates.
          
          Before test:
          - Battery SOC: {{ states('sensor.batterie_soc') }}%
          - Charging State: {{ states('sensor.charging_state') }}
          
          Monitor the battery for 5-10 minutes to verify it stays steady.
          Use script.stop_hold_soc_test to restore normal operation.
    - service: script.turn_on
      target:
        entity_id: script.hold_battery_soc
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_hold_soc_test_active

test_hold_soc_minimal_rates:
  alias: "TEST: Hold SOC with Minimal Rates"
  description: "Test script - Hold battery with 1% charge/discharge allowance"
  sequence:
    - service: notify.persistent_notification
      data:
        title: "Battery Hold SOC Test Started (Minimal)"
        message: >
          Testing hold SOC with 1% minimal rates.
          
          Before test:
          - Battery SOC: {{ states('sensor.batterie_soc') }}%
          - Charging State: {{ states('sensor.charging_state') }}
          
          Monitor the battery for 5-10 minutes to verify it stays steady.
          Use script.stop_hold_soc_test to restore normal operation.
    - service: script.turn_on
      target:
        entity_id: script.hold_battery_soc_minimal
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_hold_soc_test_active

stop_hold_soc_test:
  alias: "TEST: Stop Hold SOC Test"
  description: "Stop hold SOC test and restore normal battery operation"
  sequence:
    - service: notify.persistent_notification
      data:
        title: "Battery Hold SOC Test Stopped"
        message: >
          Test completed. Restoring normal battery operation.
          
          After test:
          - Battery SOC: {{ states('sensor.batterie_soc') }}%
          - Charging State: {{ states('sensor.charging_state') }}
          
          Review the battery behavior during the test period.
    - service: script.turn_on
      target:
        entity_id: script.set_regular_charge
    - service: switch.turn_off
      target:
        entity_id: switch.StorCtl_Mod
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.battery_hold_soc_test_active

verify_hold_soc_status:
  alias: "TEST: Verify Hold SOC Status"
  description: "Check current battery status and modbus register values"
  sequence:
    - service: notify.persistent_notification
      data:
        title: "Battery Hold SOC Status"
        message: >
          Current Battery Status:
          
          - Battery SOC: {{ states('sensor.batterie_soc') | default('N/A') }}%
          - Charging State: {{ states('sensor.charging_state') | default('N/A') }}
          - StorCtl_Mod: {{ states('sensor.battery_control_mode_read_write') | default('N/A') }}
          - Discharge Rate: {{ states('sensor.percent_max_discharge_rte') | default('N/A') }}%
          - Charge Rate: {{ states('sensor.percent_max_charge_rte') | default('N/A') }}%
          - Test Active: {{ states('input_boolean.battery_hold_soc_test_active') | default('N/A') }}
          
          Expected for Hold Mode:
          - Charging State should be: HOLDING or OFF
          - Both rates should be: 0% or very low
          - StorCtl_Mod should be: 3 (ON)
