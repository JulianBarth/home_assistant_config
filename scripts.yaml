# SPDX-License-Identifier: BSD-3-Clause
#
# Copyright (c) 2024, Julian Bartholomeyczik
# All rights reserved.

# =============================================================================
# BATTERY CHARGE RATE CONTROL SCRIPTS
# These scripts control the Fronius inverter via Modbus to set charge/discharge rates
# Modbus registers: 40365 (OutWRte - discharge), 40366 (InWRte - charge)
# Values are in 0.01% increments (10000 = 100%)
# =============================================================================

set_regular_charge:
  alias: "Set Regular Charge"
  description: "Restore normal charge/discharge behavior (100% both directions)"
  sequence:
    # OutWRte - Set discharge rate to 100%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 10000
    # InWRte - Set charge rate to 100%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

set_limited_discharge:
  alias: "Set Limited Discharge"
  description: "Limit battery discharge to 10% (used during car charging)"
  sequence:
    # OutWRte - Limit discharge to 10% of max power
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 1000
    # InWRte - Allow full charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

half_regular_charge:
  alias: "Half Regular Charge"
  description: "Set both charge and discharge to 50% of maximum"
  sequence:
    # OutWRte - Set discharge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 5000
    # InWRte - Set charge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 5000

discharge_at_half_rate:
  alias: "Discharge at Half Rate"
  description: "Discharge at 50% while preventing charging"
  sequence:
    # OutWRte - Set discharge to 50%
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 5000
    # InWRte - Prevent charging (negative value: 65536 - 5000 = 60536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 60536

forced_half_recharge:
  alias: "Forced Half Recharge"
  description: "Force charging at minimum 50% power"
  sequence:
    # OutWRte - Prevent discharge (negative value: 65536 - 5000 = 60536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 60536
    # InWRte - Allow full charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

forced_full_recharge:
  alias: "Forced Full Recharge"
  description: "Force charging at maximum power while preventing discharge"
  sequence:
    # OutWRte - Prevent discharge (negative value: 65536 - 8000 = 57536)
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40365
        value: 57536
    # InWRte - Allow maximum charge rate
    - service: modbus.write_register
      data:
        hub: fronius1
        unit: 1
        address: 40366
        value: 10000

# =============================================================================
# HIGH-LEVEL BATTERY CONTROL SCRIPTS
# These scripts orchestrate battery charging and discharging automation
# =============================================================================

start_battery_charging:
  alias: "Start Battery Charging with Target SoC"
  description: "Activate battery charging mode with forced full recharge"
  sequence:
    # Configure inverter for forced full recharge
    - service: script.turn_on
      target:
        entity_id: script.forced_full_recharge
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # Set status flag
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_charging_active

stop_battery_charging:
  alias: "Stop Battery Charging"
  description: "Deactivate battery charging and restore normal behavior"
  sequence:
    # Restore regular charge/discharge behavior
    - service: script.turn_on
      target:
        entity_id: script.set_regular_charge
    # Disable storage control mode
    - action: switch.turn_off
      target:
        entity_id: switch.StorCtl_Mod
    # Clear status flag
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.battery_charging_active

start_limit_discharging:
  alias: "Start Limit Discharging"
  description: "Limit battery discharge (e.g., during car charging)"
  sequence:
    # Configure inverter for limited discharge
    - service: script.turn_on
      target:
        entity_id: script.set_limited_discharge
    # Enable storage control mode
    - action: switch.turn_on
      target:
        entity_id: switch.StorCtl_Mod
    # Set status flag
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_no_discharging_active

stop_limit_discharging:
  alias: "Stop Limit Discharging"
  description: "Remove discharge limitation and restore normal behavior"
  sequence:
    # Restore regular charge/discharge behavior
    - service: script.turn_on
      target:
        entity_id: script.set_regular_charge
    # Disable storage control mode
    - action: switch.turn_off
      target:
        entity_id: switch.StorCtl_Mod
    # Clear status flag
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.battery_no_discharging_active
