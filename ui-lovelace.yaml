# SPDX-License-Identifier: BSD-3-Clause
#
# Copyright (c) 2024, Julian Bartholomeyczik
# All rights reserved.

# Battery Management Dashboard
title: Battery Management System
views:

  # =========================================================================
  # VIEW 1: OVERVIEW ‚Äî At-a-glance system status
  # =========================================================================
  - title: Overview
    path: overview
    icon: mdi:view-dashboard
    cards:
      # --- POWER FLOW VISUALIZATION (animated) ---
      - type: custom:power-flow-card-plus
        entities:
          battery:
            entity: sensor.battery_power
            state_of_charge: sensor.batterie_soc
            icon: mdi:battery
            display_state: one_way
            color:
              icon_color: var(--state-icon-color)
            state_of_charge_unit_white_space: false
          grid:
            entity: sensor.grid_power
            icon: mdi:transmission-tower
            display_state: one_way
            color_icon: true
          solar:
            entity: sensor.total_solar_power
            icon: mdi:solar-power
            display_state: one_way
            color_icon: true
            color:
              icon_color: var(--warning-color)
          home:
            entity: sensor.house_consumption
            icon: mdi:home
            override_state: true
        clickable_entities: true
        display_zero_lines:
          mode: show
          transparency: 50
        use_new_flow_rate_model: true
        w_decimals: 0
        min_flow_rate: 0.75
        max_flow_rate: 6
        watt_threshold: 0
        kw_decimals: 1

      # --- BATTERY + ALGORITHM STATUS ---
      - type: vertical-stack
        cards:
          - type: horizontal-stack
            cards:
              - type: gauge
                entity: sensor.batterie_soc
                name: Battery
                min: 0
                max: 100
                severity:
                  green: 50
                  yellow: 20
                  red: 0
                needle: true
              - type: gauge
                entity: sensor.total_solar_power
                name: Solar
                min: 0
                max: 7000
                needle: true
                severity:
                  green: 1000
                  yellow: 100
                  red: 0

          - type: entities
            title: "‚ö° System Status"
            show_header_toggle: false
            state_color: true
            entities:
              - entity: sensor.charging_state
                name: Battery State
              - entity: sensor.battery_control_mode
                name: Control Mode
                icon: mdi:state-machine
              - entity: sensor.computed_target_soc
                name: Smart Target SoC
                icon: mdi:target-account
              - type: divider
              - entity: sensor.tibber_energy_prices
                name: Current Price
              - entity: sensor.tibber_energy_price_percentile_next_12_hours
                name: Price Percentile (12h)

      # --- ALGORITHM DECISION (Transparency) ---
      - type: markdown
        title: "üß† Algorithm Decision"
        content: |
          **Target:** {{ states('sensor.computed_target_soc') }}% &nbsp; | &nbsp;
          **SoC:** {{ states('sensor.batterie_soc') }}% &nbsp; | &nbsp;
          **Mode:** {{ states('sensor.battery_control_mode') }}

          {% set data = state_attr('sensor.battery_optimization_data', 'calculation_data') %}
          {% if data %}
          **Reason:** {{ data.decision_reason }}

          | Metric | Value |
          |--------|-------|
          | Bridge Period | {{ data.bridge_hours }}h ({{ data.bridge_type }}) |
          | Bridge Consumption | {{ data.bridge_consumption_wh }} Wh |
          | Solar (usable) | {{ data.usable_solar_wh }} Wh |
          | Energy Deficit | {{ data.energy_deficit_wh }} Wh |
          | Price Percentile | {{ data.price_percentile }}% |
          | Price Drop | {{ data.price_drop_cents }} ct |
          {% endif %}

      # --- QUICK CONTROLS ---
      - type: entities
        title: "‚öôÔ∏è Quick Controls"
        show_header_toggle: false
        entities:
          - entity: input_boolean.battery_automation_on
            name: Automation Enabled
          - entity: input_boolean.manual_battery_charge
            name: Manual Charge
          - entity: input_number.manual_charge_target_soc
            name: Manual Target
          - type: divider
          - entity: input_boolean.battery_charging_active
            name: Charging Active
          - entity: input_boolean.battery_no_discharging_active
            name: Discharge Limited

      # --- SOC HISTORY (compact) ---
      - type: history-graph
        title: "Battery SoC (24h)"
        hours_to_show: 24
        entities:
          - entity: sensor.batterie_soc
            name: SoC
          - entity: sensor.computed_target_soc
            name: Smart Target

  # =========================================================================
  # VIEW 2: ENERGY FLOW ‚Äî Real-time visualization + Sankey
  # =========================================================================
  - title: Energy Flow
    path: energy_flow
    icon: mdi:chart-sankey
    cards:
      # --- SANKEY CHART ---
      - type: custom:sankey-chart
        title: "üîã Energy Flow"
        height: 600
        wide: true
        show_names: true
        show_values: true
        show_units: true
        sections:
          - entities:
              - entity_id: sensor.total_solar_power
                name: Solar Production
                color: '#FFB300'
                children:
                  - sensor.solar_to_house
                  - sensor.solar_to_battery
                  - sensor.solar_to_grid
              - entity_id: sensor.sankey_grid_import
                name: Grid
                color: '#2196F3'
                children:
                  - sensor.grid_to_house
                  - sensor.grid_to_battery
              - entity_id: sensor.sankey_battery_discharge
                name: Battery
                color: '#4CAF50'
                children:
                  - sensor.battery_to_house
          - entities:
              - entity_id: sensor.solar_to_house
                name: "Solar ‚Üí House"
                children:
                  - sensor.house_consumption
              - entity_id: sensor.solar_to_battery
                name: "Solar ‚Üí Battery"
              - entity_id: sensor.solar_to_grid
                name: "Solar ‚Üí Grid"
              - entity_id: sensor.grid_to_house
                name: "Grid ‚Üí House"
                children:
                  - sensor.house_consumption
              - entity_id: sensor.grid_to_battery
                name: "Grid ‚Üí Battery"
              - entity_id: sensor.battery_to_house
                name: "Battery ‚Üí House"
                children:
                  - sensor.house_consumption
          - entities:
              - entity_id: sensor.house_consumption
                name: House
                color: '#FF5722'
        min_box_height: 3
        min_box_distance: 5

      # --- POWER FLOW HISTORY ---
      - type: history-graph
        title: "Energy Flow History (2h)"
        hours_to_show: 2
        refresh_interval: 30
        entities:
          - entity: sensor.total_solar_power
            name: Solar
          - entity: sensor.grid_power
            name: Grid
          - entity: sensor.battery_power
            name: Battery
          - entity: sensor.house_consumption
            name: House
          - entity: sensor.wallbox_power
            name: Wallbox

      # --- FLOW DETAIL ---
      - type: entities
        title: "üîÑ Flow Details"
        show_header_toggle: false
        state_color: true
        entities:
          - type: section
            label: Solar Flows
          - entity: sensor.solar_to_house
            name: "Solar ‚Üí House"
            icon: mdi:arrow-right
          - entity: sensor.solar_to_battery
            name: "Solar ‚Üí Battery"
            icon: mdi:arrow-right
          - entity: sensor.solar_to_grid
            name: "Solar ‚Üí Grid"
            icon: mdi:arrow-right
          - type: divider
          - type: section
            label: Grid & Battery Flows
          - entity: sensor.grid_to_house
            name: "Grid ‚Üí House"
            icon: mdi:arrow-right
          - entity: sensor.grid_to_battery
            name: "Grid ‚Üí Battery"
            icon: mdi:arrow-right
          - entity: sensor.battery_to_house
            name: "Battery ‚Üí House"
            icon: mdi:arrow-right

  # =========================================================================
  # VIEW 3: SOLAR ‚Äî Production details
  # =========================================================================
  - title: Solar
    path: solar
    icon: mdi:solar-power
    cards:
      - type: gauge
        entity: sensor.total_solar_power
        name: Total Solar Production
        min: 0
        max: 6800
        severity:
          green: 1000
          yellow: 100
          red: 0
        needle: true

      - type: entities
        title: "‚òÄÔ∏è Solar Systems"
        show_header_toggle: false
        state_color: true
        entities:
          - entity: sensor.total_solar_power
            name: Total Power
            icon: mdi:solar-power-variant
          - type: divider
          - type: section
            label: Fronius Gen24 6.0
          - entity: sensor.fronius_solar_power
            name: Current Power
            icon: mdi:solar-panel-large
          - entity: sensor.fronius_solar_status
            name: Status
          - entity: binary_sensor.fronius_solar_online
            name: Online
          - type: divider
          - type: section
            label: Balkonkraftwerk Deye (800W)
          - entity: sensor.balkonkraftwerk_power
            name: Current Power
            icon: mdi:solar-panel
          - entity: sensor.balkonkraftwerk_daily_energy
            name: Daily Energy
          - entity: sensor.balkonkraftwerk_status
            name: Status
          - entity: binary_sensor.balkonkraftwerk_online
            name: Online

      - type: history-graph
        title: "Solar Power (24h)"
        hours_to_show: 24
        entities:
          - entity: sensor.fronius_solar_power
            name: Fronius
          - entity: sensor.balkonkraftwerk_power
            name: Balkonkraftwerk
          - entity: sensor.total_solar_power
            name: Total

      - type: entities
        title: "‚òÄÔ∏è Solar Forecast"
        show_header_toggle: false
        entities:
          - entity: sensor.solcast_pv_forecast_prognose_verbleibende_leistung_heute
            name: Remaining Today
          - entity: sensor.solcast_pv_forecast_forecast_next_x_hours
            name: Forecast Next Hours
          - entity: binary_sensor.expected_sun_low
            name: Expected Sun Low
          - entity: binary_sensor.expected_sun_very_low
            name: Expected Sun Very Low

      - type: entities
        title: "Balkonkraftwerk Details"
        show_header_toggle: false
        entities:
          - entity: sensor.inverter_grid_voltage
            name: Grid Voltage
          - entity: sensor.inverter_grid_frequency
            name: Grid Frequency
          - entity: sensor.inverter_temperature
            name: Temperature

  # =========================================================================
  # VIEW 4: CHARGING LOGIC ‚Äî Algorithm decision analysis
  # =========================================================================
  - title: Charging Logic
    path: charging_logic
    icon: mdi:lightning-bolt
    cards:
      # --- ALGORITHM DECISION DETAIL ---
      - type: markdown
        title: "üß† Algorithm Decision Detail"
        content: |
          {% set data = state_attr('sensor.battery_optimization_data', 'calculation_data') %}
          {% if data %}
          ## Current Decision
          **Target SoC:** {{ states('sensor.computed_target_soc') }}%
          **Reason:** {{ data.decision_reason }}

          ### Bridge Period Analysis
          | Parameter | Value |
          |-----------|-------|
          | Bridge Type | {{ data.bridge_type }} |
          | Bridge Hours | {{ data.bridge_hours }}h |
          | Consumption (bridge) | {{ data.bridge_consumption_wh }} Wh |
          | Solar Remaining | {{ data.expected_solar_wh }} Wh |
          | Usable Solar | {{ data.usable_solar_wh }} Wh |
          | Low Solar Day | {{ data.is_low_solar_day }} |
          | Energy Deficit | {{ data.energy_deficit_wh }} Wh |

          ### Price Analysis
          | Parameter | Value |
          |-----------|-------|
          | Current Price | {{ data.current_price_cents }} ct/kWh |
          | Next Price | {{ data.next_price_cents }} ct/kWh |
          | Price Drop | {{ data.price_drop_cents }} ct |
          | Percentile | {{ data.price_percentile }}% |
          | Max Allowed | {{ data.max_price_cents }} ct/kWh |
          {% else %}
          *Waiting for data...*
          {% endif %}

      - type: entities
        title: "Decision Sensors"
        show_header_toggle: false
        state_color: true
        entities:
          - entity: binary_sensor.should_start_charging
            name: Should Start Charging
          - entity: binary_sensor.should_stop_charging
            name: Should Stop Charging
          - entity: binary_sensor.should_hold_battery_soc
            name: Should Hold SoC
          - entity: binary_sensor.should_prevent_discharge
            name: Should Prevent Discharge
          - type: divider
          - entity: binary_sensor.battery_charging_is_profitable_enhanced
            name: Profitable to Charge
          - entity: binary_sensor.should_charge_battery_during_car_charging
            name: Allow Charge + Car
          - entity: binary_sensor.car_charging_stable
            name: Car Charging (Stable)
          - type: divider
          - entity: sensor.discharge_limit_percentage
            name: Discharge Limit

      # --- PRICE vs CHARGING (48h) ---
      - type: history-graph
        title: "Price vs Charging Decision (48h)"
        hours_to_show: 48
        entities:
          - entity: sensor.tibber_energy_prices
            name: Price (EUR/kWh)
          - entity: sensor.computed_target_soc
            name: Smart Target SoC (%)
          - entity: sensor.batterie_soc
            name: Battery SoC (%)
          - entity: binary_sensor.should_start_charging
            name: Start Signal
          - entity: input_boolean.battery_charging_active
            name: Charging Active

      # --- PROFITABILITY ---
      - type: history-graph
        title: "Profitability Factors (24h)"
        hours_to_show: 24
        entities:
          - entity: sensor.tibber_energy_prices
            name: Current Price
          - entity: sensor.tibber_energy_average_price_next_12_hours
            name: Avg Price (12h)
          - entity: sensor.tibber_energy_highest_price_next_24_hours
            name: Max Price (24h)
          - entity: sensor.tibber_energy_price_percentile_next_12_hours
            name: Price Percentile

      # --- SOLAR IMPACT ---
      - type: history-graph
        title: "Solar Forecast Impact (24h)"
        hours_to_show: 24
        entities:
          - entity: sensor.solcast_pv_forecast_prognose_verbleibende_leistung_heute
            name: Solar Remaining
          - entity: binary_sensor.expected_sun_low
            name: Low Sun Flag
          - entity: binary_sensor.expected_sun_very_low
            name: Very Low Sun Flag

      # --- WALLBOX ---
      - type: entities
        title: "üöó Wallbox & Car"
        show_header_toggle: false
        entities:
          - entity: sensor.wattpilot_carconnected
            name: Status
          - entity: select.wattpilot_charging_mode
            name: Mode
          - entity: sensor.wallbox_power
            name: Charging Power
          - entity: input_boolean.battery_no_discharging_active
            name: Discharge Limited (Car)

  # =========================================================================
  # VIEW 5: MONITORING ‚Äî Historical graphs
  # =========================================================================
  - title: Monitoring
    path: monitoring
    icon: mdi:chart-line
    cards:
      - type: history-graph
        title: "üîã Battery SoC (24h)"
        hours_to_show: 24
        entities:
          - entity: sensor.batterie_soc
            name: Battery SoC
          - entity: input_number.battery_target_soc
            name: Target SoC
          - entity: sensor.computed_target_soc
            name: Smart Target

      - type: history-graph
        title: "Charging State (24h)"
        hours_to_show: 24
        entities:
          - entity: input_boolean.battery_charging_active
            name: Charging Active
          - entity: input_boolean.battery_no_discharging_active
            name: Discharge Limited
          - entity: binary_sensor.should_start_charging
            name: Should Start

      - type: history-graph
        title: "üí∞ Price History (24h)"
        hours_to_show: 24
        entities:
          - entity: sensor.tibber_energy_prices
            name: Energy Price

      - type: history-graph
        title: "‚òÄÔ∏è Solar Production (24h)"
        hours_to_show: 24
        entities:
          - entity: sensor.total_solar_power
            name: Total Solar
          - entity: sensor.fronius_solar_power
            name: Fronius
          - entity: sensor.balkonkraftwerk_power
            name: Balkonkraftwerk

      - type: entities
        title: "System Health"
        show_header_toggle: false
        entities:
          - entity: binary_sensor.tibber_pulse_not_functioning
            name: Tibber Pulse Status
          - entity: sensor.battery_control_status
            name: Control Status

  # =========================================================================
  # VIEW 6: CONFIGURATION ‚Äî Settings and manual controls
  # =========================================================================
  - title: Configuration
    path: configuration
    icon: mdi:cog
    cards:
      - type: entities
        title: "‚öôÔ∏è Battery Algorithm Settings"
        show_header_toggle: false
        entities:
          - type: section
            label: Target SoC
          - entity: input_number.soc_target_default
            name: Default Target
          - entity: input_number.soc_hist
            name: SoC Hysteresis
          - entity: input_number.battery_hold_threshold
            name: Hold Threshold
          - entity: input_number.battery_discharge_buffer
            name: Discharge Buffer
          - type: divider
          - type: section
            label: Price Controls
          - entity: input_number.max_charge_price_cents
            name: Max Charging Price
          - entity: input_number.battery_wear_cost_per_kwh
            name: Battery Wear Cost
          - type: divider
          - type: section
            label: Consumption Model
          - entity: input_number.daily_consumption_wh
            name: Daily Consumption
          - entity: input_number.night_consumption_rate_wh
            name: Night Rate
          - entity: input_number.day_consumption_rate_wh
            name: Day Rate
          - entity: input_number.weekday_wake_hour
            name: Weekday Wake
          - entity: input_number.weekend_wake_hour
            name: Weekend Wake
          - entity: input_number.sleep_hour
            name: Sleep Hour
          - type: divider
          - type: section
            label: System Parameters
          - entity: input_number.battery_capacity_wh
            name: Battery Capacity
          - entity: input_number.battery_charge_rate_max
            name: Max Charge Rate
          - entity: input_number.grid_connection_capacity
            name: Grid Capacity
          - entity: input_number.low_solar_threshold_wh
            name: Low Solar Threshold

      - type: entities
        title: "Solar Forecast Thresholds"
        show_header_toggle: false
        entities:
          - entity: input_number.sun_threshold_low
            name: Low Sun Threshold
          - entity: input_number.sun_threshold_very_low
            name: Very Low Sun Threshold
          - entity: input_number.soc_target_low_sun
            name: Target (Low Sun)
          - entity: input_number.soc_target_very_low_sun
            name: Target (Very Low Sun)

      - type: entities
        title: "üîß Manual Control Scripts"
        show_header_toggle: false
        entities:
          - entity: script.start_battery_charging
            name: Start Charging
            icon: mdi:battery-charging
          - entity: script.stop_battery_charging
            name: Stop Charging
            icon: mdi:battery-off
          - entity: script.start_limit_discharging
            name: Limit Discharge
            icon: mdi:battery-lock
          - entity: script.stop_limit_discharging
            name: Stop Limit Discharge
            icon: mdi:battery-unlock
          - type: divider
          - entity: script.set_regular_charge
            name: Set Regular Charge
          - entity: script.forced_half_recharge
            name: Force Half Recharge
          - entity: script.forced_full_recharge
            name: Force Full Recharge
          - entity: script.charge_battery_reduced_rate
            name: Reduced Charge Rate
          - entity: script.hold_battery_soc
            name: Hold Battery SoC

      - type: entities
        title: "Car Charging Settings"
        show_header_toggle: false
        entities:
          - entity: input_number.car_charging_hysteresis_minutes
            name: Car Charging Hysteresis

  # =========================================================================
  # VIEW 7: DEBUG ‚Äî Development and diagnostics (moved from other views)
  # =========================================================================
  - title: Debug
    path: debug
    icon: mdi:bug
    cards:
      - type: markdown
        content: |
          ## üîß Debug & Diagnostics
          This view contains debug sensors and test scripts moved from other views.
          Use this for troubleshooting only.

      # --- SANKEY DEBUG ---
      - type: entities
        title: "üîç Sankey Chart Status"
        show_header_toggle: false
        entities:
          - entity: sensor.sankey_entity_check
            name: Entity Check Status
            icon: mdi:check-circle
          - type: attribute
            entity: sensor.sankey_entity_check
            attribute: available_count
            name: Available Entities
          - type: attribute
            entity: sensor.sankey_entity_check
            attribute: total_entities
            name: Total Entities
          - entity: sensor.sankey_debug_info
            name: Diagnosis
          - type: divider
          - entity: sensor.total_solar_power
            name: Total Solar
            secondary_info: last-changed
          - entity: sensor.grid_power
            name: Grid Power
            secondary_info: last-changed
          - entity: sensor.battery_power
            name: Battery Power
            secondary_info: last-changed
          - entity: sensor.house_consumption
            name: House Consumption
            secondary_info: last-changed

      # --- ALL ENTITY VALUES ---
      - type: entities
        title: "üîß All Sankey Entity Values"
        show_header_toggle: false
        state_color: true
        entities:
          - type: section
            label: Primary Sources
          - entity: sensor.total_solar_power
            name: Total Solar Power
            secondary_info: last-changed
          - entity: sensor.fronius_solar_power
            name: "  ‚îî‚îÄ Fronius"
            secondary_info: last-changed
          - entity: sensor.balkonkraftwerk_power
            name: "  ‚îî‚îÄ Balkonkraftwerk"
            secondary_info: last-changed
          - entity: sensor.grid_power
            name: Grid Power
            secondary_info: last-changed
          - entity: sensor.battery_power
            name: Battery Power
            secondary_info: last-changed
          - type: divider
          - type: section
            label: Flow Sensors
          - entity: sensor.solar_to_house
            name: "Solar ‚Üí House"
            secondary_info: last-changed
          - entity: sensor.solar_to_battery
            name: "Solar ‚Üí Battery"
            secondary_info: last-changed
          - entity: sensor.solar_to_grid
            name: "Solar ‚Üí Grid"
            secondary_info: last-changed
          - entity: sensor.grid_to_house
            name: "Grid ‚Üí House"
            secondary_info: last-changed
          - entity: sensor.grid_to_battery
            name: "Grid ‚Üí Battery"
            secondary_info: last-changed
          - entity: sensor.battery_to_house
            name: "Battery ‚Üí House"
            secondary_info: last-changed
          - type: divider
          - type: section
            label: Consumption
          - entity: sensor.house_consumption
            name: House Consumption
            secondary_info: last-changed
          - entity: sensor.wallbox_power
            name: Wallbox Power
            secondary_info: last-changed
          - type: divider
          - type: section
            label: Supporting Sensors
          - entity: sensor.charging_state
            name: Charging State
          - entity: sensor.reading_energy_main_meter
            name: Main Meter Reading
            secondary_info: last-changed
          - entity: sensor.reading_energy_inverter_ac_output
            name: Inverter AC Output
            secondary_info: last-changed

      # --- FRONIUS DEBUG ---
      - type: entities
        title: "Fronius Details"
        show_header_toggle: false
        entities:
          - entity: sensor.reading_energy_inverter_ac_output
            name: AC Output Power
          - entity: sensor.reading_energy_main_meter
            name: Main Meter Reading
          - entity: sensor.batterie_soc
            name: Battery SoC

      # --- TEST SCRIPTS ---
      - type: entities
        title: "üß™ Hold SOC Test Scripts"
        show_header_toggle: false
        entities:
          - entity: script.test_hold_soc_enable
            name: "TEST: Enable Hold SOC"
          - entity: script.test_hold_soc_disable
            name: "TEST: Disable Hold SOC"
          - entity: script.test_hold_soc_status
            name: "TEST: Check Status"

      # --- ALL CONTROL FLAGS ---
      - type: entities
        title: "Control Flags"
        show_header_toggle: false
        entities:
          - entity: input_boolean.battery_charging_active
          - entity: input_boolean.battery_no_discharging_active
          - entity: input_boolean.battery_automation_on
          - entity: input_boolean.manual_battery_charge
          - entity: input_boolean.manual_charging_on

      # --- ADVANCED MODBUS ---
      - type: entities
        title: "Advanced Modbus Controls"
        show_header_toggle: false
        entities:
          - entity: script.set_limited_discharge
            name: Set Limited Discharge
          - entity: script.half_regular_charge
            name: Half Regular Charge
          - entity: script.discharge_at_half_rate
            name: Discharge at Half Rate
          - entity: script.set_dynamic_discharge_limit
            name: Dynamic Discharge Limit

      # --- SYSTEM ARCHITECTURE ---
      - type: markdown
        title: "üìê System Architecture"
        content: |
          ## Energy Flow System

          ### ‚òÄÔ∏è Solar Production
          - **Fronius Gen24 6.0**: Main solar system (up to 6 kW)
          - **Deye Balkonkraftwerk**: Balcony power plant (800W)
          - **Combined Capacity**: 6.8 kW

          ### üîã Energy Storage
          - **Battery**: BYD Battery Pack (~10 kWh)
          - **Inverter**: Fronius Gen24 6.0
          - **Control**: Smart charging via Modbus TCP

          ### ‚ö° Distribution
          - **House**: General consumption (~14 kWh/day)
          - **Wallbox**: Wattpilot EV charging
          - **Grid**: Tibber variable pricing (15-min intervals)
