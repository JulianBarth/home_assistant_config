# SPDX-License-Identifier: BSD-3-Clause
#
# Copyright (c) 2024, Julian Bartholomeyczik
# All rights reserved.
# Using 15-minute pricing intervals from Tibber API
- alias: "Manual Battery Charging"
  trigger:
    - platform: state
      entity_id: input_boolean.manual_battery_charge
      to: "on"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.battery_target_soc
      data:
        value: "{{ states('input_number.manual_charge_target_soc') | float(default=80) }}"
    - service: script.turn_on
      target:
        entity_id: script.stop_limit_discharging
    - service: script.turn_on
      target:
        entity_id: script.start_battery_charging

- alias: "Manage battery charging based on price and scaled charge level"
  description: "Automated battery charging based on energy prices, solar forecast, and battery state"
  trigger:
    # Trigger on decision sensor changes (computed target is derived from these, so not needed as separate trigger)
    - platform: state
      entity_id:
        - binary_sensor.should_start_charging
        - binary_sensor.should_stop_charging
        - sensor.computed_target_soc
    # Fallback check every 5 minutes to ensure automation runs even if state changes are missed
    - platform: time_pattern
      minutes: "/5"
  action:
    - choose:
        # Start charging if conditions are met
        - conditions:
            - condition: state
              entity_id: binary_sensor.should_start_charging
              state: "on"
          sequence:
            - service: input_number.set_value
              target:
                entity_id: input_number.battery_target_soc
              data:
                value: "{{ states('sensor.computed_target_soc') | float(default=15) }}"

            # Only stop discharge limiting if car is NOT charging
            - choose:
                - conditions:
                    - condition: template
                      value_template: >
                        {% set car_charging = is_state('sensor.wattpilot_carconnected', 'charging') %}
                        {% set wallbox_not_eco = not is_state('select.wattpilot_charging_mode', 'Eco') %}
                        {{ not (car_charging and wallbox_not_eco) }}
                  sequence:
                    - service: script.turn_on
                      target:
                        entity_id: script.stop_limit_discharging

            - service: script.turn_on
              target:
                entity_id: script.start_battery_charging

        # Stop charging if battery reaches or exceeds the target SoC
        - conditions:
            - condition: state
              entity_id: binary_sensor.should_stop_charging
              state: "on"
          sequence:
            - service: script.turn_on
              target:
                entity_id: script.stop_battery_charging
            - service: input_boolean.turn_off
              entity_id: input_boolean.manual_battery_charge

- alias: "Limit discharging of home battery, if car battery is charged"
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.car_charging_stable
        - input_boolean.battery_automation_on
    - platform: time_pattern
      minutes: "/5"
  action:
    - choose:
        # Enable discharge limiting when car charging is stable
        - conditions:
            - condition: state
              entity_id: binary_sensor.car_charging_stable
              state: "on"
            - condition: state
              entity_id: input_boolean.battery_no_discharging_active
              state: "off"
            - condition: state
              entity_id: input_boolean.battery_charging_active
              state: "off"
            - condition: state
              entity_id: input_boolean.battery_automation_on
              state: "on"
          sequence:
            - service: script.turn_on
              target:
                entity_id: script.start_limit_discharging

        # Disable discharge limiting when car charging stops (stable)
        - conditions:
            - condition: state
              entity_id: binary_sensor.car_charging_stable
              state: "off"
            - condition: state
              entity_id: input_boolean.battery_no_discharging_active
              state: "on"
            - condition: state
              entity_id: input_boolean.battery_charging_active
              state: "off"
          sequence:
            - service: script.turn_on
              target:
                entity_id: script.stop_limit_discharging
- alias: Solcast update
  description: ""
  trigger:
    - platform: template
      value_template: >-
        {% set nr = as_datetime(state_attr('sun.sun','next_rising')) | as_local %}
        {% set ns = as_datetime(state_attr('sun.sun','next_setting')) | as_local %}
        {% set api_request_limit = 10 %}
        {% if nr > ns %}
          {% set nr = nr - timedelta(hours = 24) %}
        {% endif %}
        {% set hours_difference = (ns - nr) %}
        {% set interval_hours = hours_difference / api_request_limit %}
        {% set ns = namespace(match = false) %}
        {% for i in range(api_request_limit) %}
          {% set start_time = nr + (i * interval_hours) %}
          {% if ((start_time - timedelta(seconds=30)) <= now()) and (now() <= (start_time + timedelta(seconds=30))) %}
            {% set ns.match = true %}
          {% endif %}
        {% endfor %}
        {{ ns.match }}
  condition:
    - condition: sun
      before: sunset
      after: sunrise
  action:
    - delay:
        seconds: "{{ range(30, 360)|random|int }}"
    - service: solcast_solar.update_forecasts
      data: {}
  mode: single

- alias: "Notify when Battery Charging is Active"
  trigger:
    - platform: state
      entity_id: input_boolean.battery_charging_active
      to: "on"
  action:
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Battery Charging is now Active."
        title: "Battery Alert"
- alias: "Notify when No Battery Discharging is Active"
  trigger:
    - platform: state
      entity_id: input_boolean.battery_no_discharging_active
      to: "on"
  action:
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Battery Discharging is Disabled."
        title: "Battery Alert"
- alias: "Notify when Battery SoC is below 7.5%"
  trigger:
    - platform: numeric_state
      entity_id: sensor.reading_energy_battery_soc_scaled
      below: 750 # Adjust if your SoC is scaled differently (e.g., 7.5% is 750)
  action:
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Battery SoC is below 7.5%!"
        title: "Battery Alert"

- alias: "Notify when Tibber Pulse is not functioning"
  trigger:
    - platform: state
      entity_id: binary_sensor.tibber_pulse_not_functioning
      to: "on"
      for:
        minutes: 5  # Wait 5 minutes to avoid false alarms from brief disconnections
  action:
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Tibber Pulse sensor is not functioning. Please check the sensor battery or connectivity."
        title: "Tibber Pulse Alert"
