# SPDX-License-Identifier: BSD-3-Clause
#
# Copyright (c) 2024, Julian Bartholomeyczik
# All rights reserved.
# Using 15-minute pricing intervals from Tibber API
- alias: "Manual Battery Charging"
  trigger:
    - platform: state
      entity_id: input_boolean.manual_battery_charge
      to: "on"
  action:
    # Just set the flag - let unified coordinator handle the rest
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Manual battery charging requested. System will override automation."
        title: "Battery Control"

- alias: "Unified Battery Control Coordinator"
  description: "Single automation to coordinate all battery control modes"
  trigger:
    # Trigger on mode changes
    - platform: state
      entity_id: sensor.battery_control_mode
    # Trigger on SoC changes (for stop conditions and hold mode)
    - platform: state
      entity_id:
        - binary_sensor.should_stop_charging
        - binary_sensor.should_hold_battery_soc
        - binary_sensor.should_prevent_discharge
        - sensor.computed_target_soc
    # Fallback check every 5 minutes
    - platform: time_pattern
      minutes: "/5"
  action:
    - choose:
        # Mode 1: Manual Charging (Highest Priority)
        - conditions:
            - condition: state
              entity_id: sensor.battery_control_mode
              state: "manual_charging"
          sequence:
            - service: input_number.set_value
              target:
                entity_id: input_number.battery_target_soc
              data:
                value: "{{ states('input_number.manual_charge_target_soc') | float(default=80) }}"
            - service: script.turn_on
              target:
                entity_id: script.forced_full_recharge
            - service: switch.turn_on
              target:
                entity_id: switch.StorCtl_Mod
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.battery_charging_active

        # Mode 2: Car + Battery Charging
        - conditions:
            - condition: state
              entity_id: sensor.battery_control_mode
              state: "car_and_battery_charging"
            - condition: state
              entity_id: binary_sensor.should_stop_charging
              state: "off"
          sequence:
            - service: input_number.set_value
              target:
                entity_id: input_number.battery_target_soc
              data:
                value: "{{ states('sensor.computed_target_soc') | float(default=15) }}"
            - service: script.turn_on
              target:
                entity_id: script.charge_battery_limit_discharge

        # Mode 3: Car Charging Only (Limit Discharge)
        - conditions:
            - condition: state
              entity_id: sensor.battery_control_mode
              state: "car_charging_only"
          sequence:
            - service: script.turn_on
              target:
                entity_id: script.set_dynamic_discharge_limit
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.battery_no_discharging_active

        # Mode 4: Battery Charging Only
        - conditions:
            - condition: state
              entity_id: sensor.battery_control_mode
              state: "battery_charging"
            - condition: state
              entity_id: binary_sensor.should_stop_charging
              state: "off"
          sequence:
            - service: input_number.set_value
              target:
                entity_id: input_number.battery_target_soc
              data:
                value: "{{ states('sensor.computed_target_soc') | float(default=15) }}"
            - service: script.turn_on
              target:
                entity_id: script.forced_full_recharge
            - service: switch.turn_on
              target:
                entity_id: switch.StorCtl_Mod
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.battery_charging_active

      # Default: Normal Operation or Stop Charging or Hold SOC or Prevent Discharge
      default:
        - choose:
            # Check if we should hold battery SOC at target
            - conditions:
                - condition: state
                  entity_id: binary_sensor.should_hold_battery_soc
                  state: "on"
                # Double-check charging is still active to prevent race conditions
                # between sensor evaluation and script execution
                - condition: state
                  entity_id: input_boolean.battery_charging_active
                  state: "on"
              sequence:
                - service: script.turn_on
                  target:
                    entity_id: script.hold_battery_soc
            # NEW: Prevent discharge when at target SoC (keep battery at desired level)
            - conditions:
                - condition: state
                  entity_id: binary_sensor.should_prevent_discharge
                  state: "on"
              sequence:
                # Use limited discharge script to prevent draining
                - service: script.turn_on
                  target:
                    entity_id: script.set_limited_discharge
                - service: switch.turn_on
                  target:
                    entity_id: switch.StorCtl_Mod
            # Check if we should stop charging
            - conditions:
                - condition: state
                  entity_id: binary_sensor.should_stop_charging
                  state: "on"
              sequence:
                - service: script.turn_on
                  target:
                    entity_id: script.stop_battery_charging
                - service: input_boolean.turn_off
                  target:
                    entity_id:
                      - input_boolean.manual_battery_charge
                      - input_boolean.battery_no_discharging_active
          # Normal operation
          default:
            - service: script.turn_on
              target:
                entity_id: script.set_regular_charge
            - service: switch.turn_off
              target:
                entity_id: switch.StorCtl_Mod
            - service: input_boolean.turn_off
              target:
                entity_id:
                  - input_boolean.battery_charging_active
                  - input_boolean.battery_no_discharging_active
- alias: Solcast update
  description: ""
  trigger:
    - platform: template
      value_template: >-
        {% set nr = as_datetime(state_attr('sun.sun','next_rising')) | as_local %}
        {% set ns = as_datetime(state_attr('sun.sun','next_setting')) | as_local %}
        {% set api_request_limit = 10 %}
        {% if nr > ns %}
          {% set nr = nr - timedelta(hours = 24) %}
        {% endif %}
        {% set hours_difference = (ns - nr) %}
        {% set interval_hours = hours_difference / api_request_limit %}
        {% set ns = namespace(match = false) %}
        {% for i in range(api_request_limit) %}
          {% set start_time = nr + (i * interval_hours) %}
          {% if ((start_time - timedelta(seconds=30)) <= now()) and (now() <= (start_time + timedelta(seconds=30))) %}
            {% set ns.match = true %}
          {% endif %}
        {% endfor %}
        {{ ns.match }}
  condition:
    - condition: sun
      before: sunset
      after: sunrise
  action:
    - delay:
        seconds: "{{ range(30, 360)|random|int }}"
    - service: solcast_solar.update_forecasts
      data: {}
  mode: single

- alias: "Notify when Battery Charging is Active"
  trigger:
    - platform: state
      entity_id: input_boolean.battery_charging_active
      to: "on"
  action:
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Battery Charging is now Active."
        title: "Battery Alert"
- alias: "Notify when No Battery Discharging is Active"
  trigger:
    - platform: state
      entity_id: input_boolean.battery_no_discharging_active
      to: "on"
  action:
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Battery Discharging is Disabled."
        title: "Battery Alert"
- alias: "Notify when Battery SoC is below 7.5%"
  trigger:
    - platform: numeric_state
      entity_id: sensor.reading_energy_battery_soc_scaled
      below: 750  # Adjust if your SoC is scaled differently (e.g., 7.5% is 750)
  action:
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Battery SoC is below 7.5%!"
        title: "Battery Alert"

- alias: "Notify when Tibber Pulse is not functioning"
  trigger:
    - platform: state
      entity_id: binary_sensor.tibber_pulse_not_functioning
      to: "on"
      for:
        minutes: 5  # Wait 5 minutes to avoid false alarms from brief disconnections
  action:
    - service: notify.mobile_app_f4gdn4ry0gpq_2
      data:
        message: "Tibber Pulse sensor is not functioning. Please check the sensor battery or connectivity."
        title: "Tibber Pulse Alert"
